# MODX Shopkeeper 2.3

#### Тестировалось и писалось для MODX 2.3.2 Shopkeeper 2.3.10.

1. Регистрируемся на <a href="https://paybox.money" target="_blank">paybox.money</a>
2. Для установки платежного модуля Paybox необходимо произвести следующие действия:
Скачайте архив модуля и распакуйте его. Загрузите архив `payment-1.0.transport.zip` в папку `core/packages/` вашего сайта.
В панели управления перейдите "Система" - "Управление пакетами" - "Добавить новый пакет" - "Искать пакеты локально" - "Дальше".
В таблице пакетов появится пакет "payment". Нажмите кнопку "Установить".
Завершите установку.
3. Необходимо создать 4 страницы:
Страница оплаты через Paybox. 
Вставить в поле "Содержимое ресурса" вызов сниппета:
[[!Paybox? action=`payment`]]
Страница с сообщением об успешной оплате (с любым содержанием)
Страница с сообщением об отмене оплаты (с любым содержанием)
Страница для подтверждения оплаты. Вставить в поле "Содержимое ресурса" вызов сниппета:
[[!Paybox? action=`callback`]]

4. Измените параметры сниппета Paybox:
`PL_MERCHANT_ID` – Номер магазина в https://paybox.money
`PL_SECRET_KEY` - Секретный ключ в https://paybox.money
`PL_LIFETIME` – Время жизни счета для ПС, не поддерживающих проверку счета. 0 - не учитывается. Указывается в минутах
`PL_CURRENCY_CODE` - код валюты (\'RUR\')
`PL_TEST_MODE` – 0. Тестовый режим для проверки взаимодействия.
`PL_SUCCESS_URL` - http://имя_вашего_сайта/index.php?id=ID_страницы
ID_страницы - страница с сообщением об успешной оплате
`PL_FAIL_URL` - http://имя_вашего_сайта/index.php?id=ID_страницы
ID_страницы - страница с сообщением об отмене оплаты
`PL_CALLBACK_URL` - http://имя_вашего_сайта/index.php?id=ID_страницы
ID_страницы - страница для подтверждения оплаты
`PAYMENT_FORM` - http://имя_вашего_сайта/index.php?id=ID_страницы
ID_страницы - страница с формой оплаты Paybox \*

5. В шаблоне формы оформления заказа должен быть выпадающий список (select) для выбора метода оплаты. Пример:
```
<select name="payment">
    <option value="При получении" [[!+fi.payment:FormItIsSelected=`При получении`]]>При получении</option>
   <option value="WebMoney" [[!+fi.payment:FormItIsSelected=`WebMoney`]]>WebMoney</option>
</select>
```
Добавьте строку `<option value="paybox">Paybox</option>`. Должно выглядеть, например, так:
```
<select name="payment">
    <option value="paybox" [[!+fi.payment:FormItIsSelected=`paybox`]]>Paybox</option>
    <option value="При получении" [[!+fi.payment:FormItIsSelected=`При получении`]]>При получении</option>
    <option value="WebMoney" [[!+fi.payment:FormItIsSelected=`WebMoney`]]>WebMoney</option>
</select>
```
На странице формы оформления заказа в вызове сниппета FormIt в список используемых хуков необходимо добавить paybox перед redirect.
Теперь после отправки заказа на следующей странице будет появляться кнопка "Оплатить сейчас".

Удачных платежей.

\* Чтобы не принимать оплату по конкретной транзакции нужно поменять статус заказа на отменен или удалить заказ.
